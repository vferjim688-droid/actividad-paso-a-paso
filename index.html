<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Resumen IA (Modo Clase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Incluir la librer√≠a pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Configurar workerSrc ANTES de cargar Firebase
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .prose-custom p, .prose-custom li { margin-bottom: 1em; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { margin-bottom: 0.5em; font-weight: 600; }
        .prose-custom ul { list-style-type: disc; margin-left: 1.5em; }
        .prose-custom ol { list-style-type: decimal; margin-left: 1.5em; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- MODAL PARA LA CLAVE DE API (MODO CLASE) -->
    <div id="api-key-modal" class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Modo Clase</h2>
        <p class="text-gray-600 mb-6">Por favor, introduce la clave de API de la clase para activar la herramienta.</p>
        <input id="api-key-input" type="password" placeholder="Clave de API de la Clase" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        <button id="save-api-key-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">
            Activar Herramienta
        </button>
        <p id="api-key-error" class="text-red-500 text-sm mt-4 hidden"></p>
    </div>

    <!-- APLICACI√ìN PRINCIPAL (Oculta hasta que se ingrese la clave) -->
    <div id="main-app" class="hidden w-full max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-8 md:p-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">Herramienta de Resumen IA</h1>
            <p class="text-lg text-gray-600 mt-2">Sube un PDF, escribe tu resumen y deja que la IA eval√∫e tu razonamiento.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            
            <!-- Columna Izquierda: PDF y Evaluaci√≥n IA -->
            <div class="flex flex-col space-y-8">
                <!-- Secci√≥n de Carga de PDF -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">1. Carga tu PDF</h2>
                    <div class="flex items-center justify-center w-full">
                        <label for="pdf-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Haz clic para subir</span> o arrastra y suelta</p>
                                <p class="text-xs text-gray-500">Solo archivos PDF</p>
                            </div>
                            <input id="pdf-upload" type="file" class="hidden" accept="application/pdf" />
                        </label>
                    </div>
                    <p id="pdf-file-name" class="text-sm text-gray-600 mt-4 font-medium"></p>
                    <pre id="pdf-text-content" class="hidden mt-4 p-4 bg-gray-100 rounded-lg text-sm text-gray-700 max-h-64 overflow-y-auto whitespace-pre-wrap"></pre>
                </div>

                <!-- Secci√≥n de Evaluaci√≥n IA -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">3. Evaluaci√≥n de la IA</h2>
                    <div id="ia-feedback-container" class="w-full h-64 p-4 border border-gray-300 rounded-lg bg-gray-50 overflow-y-auto">
                        <p id="ia-feedback-placeholder" class="text-gray-500">La evaluaci√≥n de la IA aparecer√° aqu√≠...</p>
                        <div id="ia-feedback" class="prose-custom"></div>
                    </div>
                    <p id="gemini-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
            </div>

            <!-- Columna Derecha: Resumen del Alumno -->
            <div class="flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">2. Escribe tu Resumen</h2>
                <input id="summary-title-input" type="text" placeholder="T√≠tulo para tu resumen (opcional)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <textarea id="student-summary" class="w-full flex-grow p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" placeholder="Escribe aqu√≠ tu resumen del PDF..." style="min-height: 400px;"></textarea>
                
                <div class="flex flex-wrap items-center justify-between mt-6 gap-4">
                    <div class="flex items-center gap-4">
                       <button id="gemini-evaluate-btn" disabled class="flex items-center justify-center space-x-2 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition" style="min-width: 220px;">
                           <span id="gemini-btn-text">‚ú® Evaluar Resumen</span>
                           <div id="gemini-loader" class="loader hidden"></div>
                       </button>
                       <button id="download-btn" disabled class="flex items-center space-x-2 bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                           <span>üì• Descargar</span>
                       </button>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Palabras: <span id="word-count">0</span></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Script principal de la aplicaci√≥n -->
    <script type="module">
        // *** 1. IMPORTACIONES DE FIREBASE ***
        // (Se asume que est√°s usando la versi√≥n modular v9+ de Firebase)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // *** 2. CONFIGURACI√ìN DE FIREBASE ***
        // ¬°¬°¬°IMPORTANTE!!!
        // PEGA AQU√ç TU OBJETO de configuraci√≥n de Firebase.
        // NO subas esto con tus claves reales a un repositorio P√öBLICO si no usas hosting de Firebase.
        // Para GitHub Pages, las reglas de seguridad de Firestore son tu principal defensa.
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // *** 3. INICIALIZACI√ìN DE FIREBASE Y VARIABLES GLOBALES ***
        let app, auth, db, userId;
        let originalPdfText = ""; // Almacena el texto extra√≠do del PDF
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // setLogLevel('debug'); // Descomenta para depuraci√≥n de Firestore
            console.log("Firebase inicializado.");
            initFirebase();
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            document.getElementById("api-key-error").textContent = "Error al conectar con la base de datos. Recarga la p√°gina.";
            document.getElementById("api-key-error").classList.remove("hidden");
        }

        // *** 4. L√ìGICA DE INICIO (MODO CLASE) ***
        const apiKeyModal = document.getElementById("api-key-modal");
        const mainApp = document.getElementById("main-app");
        const apiKeyInput = document.getElementById("api-key-input");
        const saveApiKeyBtn = document.getElementById("save-api-key-btn");
        const apiKeyError = document.getElementById("api-key-error");

        function initApp() {
            const storedApiKey = sessionStorage.getItem("geminiApiKey");
            if (storedApiKey) {
                apiKeyModal.classList.add("hidden");
                mainApp.classList.remove("hidden");
            } else {
                apiKeyModal.classList.remove("hidden");
                mainApp.classList.add("hidden");
            }
        }

        saveApiKeyBtn.addEventListener("click", () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                sessionStorage.setItem("geminiApiKey", apiKey);
                apiKeyError.classList.add("hidden");
                initApp();
            } else {
                apiKeyError.textContent = "Por favor, introduce una clave de API v√°lida.";
                apiKeyError.classList.remove("hidden");
            }
        });

        // *** 5. L√ìGICA DE FIREBASE Y AUTENTICACI√ìN ***
        async function initFirebase() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // El usuario est√° conectado an√≥nimamente
                    userId = user.uid;
                    console.log("Usuario conectado an√≥nimamente:", userId);
                } else {
                    // El usuario no est√° conectado
                    signInAnonymously(auth).catch((error) => {
                        console.error("Error en el inicio de sesi√≥n an√≥nimo:", error);
                    });
                }
            });
        }

        // *** 6. L√ìGICA DE PDF.JS ***
        const pdfUpload = document.getElementById("pdf-upload");
        const pdfFileName = document.getElementById("pdf-file-name");
        const pdfTextContent = document.getElementById("pdf-text-content");

        pdfUpload.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file || file.type !== "application/pdf") {
                alert("Por favor, sube solo archivos PDF.");
                return;
            }

            pdfFileName.textContent = `Archivo cargado: ${file.name}`;
            originalPdfText = ""; // Limpia el texto anterior

            try {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(" ") + "\n\n";
                    }
                    originalPdfText = fullText;
                    // pdfTextContent.textContent = originalPdfText; // Opcional: mostrar el texto
                    // pdfTextContent.classList.remove("hidden");
                    console.log("PDF procesado.");
                    checkEnableButtons();
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error al procesar el PDF:", error);
                pdfFileName.textContent = "Error al procesar el PDF.";
                originalPdfText = "";
                checkEnableButtons();
            }
        });

        // *** 7. L√ìGICA DE LA API DE GEMINI ***
        const geminiEvaluateBtn = document.getElementById("gemini-evaluate-btn");
        const geminiBtnText = document.getElementById("gemini-btn-text");
        const geminiLoader = document.getElementById("gemini-loader");
        const geminiError = document.getElementById("gemini-error");
        const iaFeedback = document.getElementById("ia-feedback");
        const iaFeedbackPlaceholder = document.getElementById("ia-feedback-placeholder");
        const studentSummary = document.getElementById("student-summary");

        geminiEvaluateBtn.addEventListener("click", callGeminiAPI);

        async function callGeminiAPI() {
            const apiKey = sessionStorage.getItem("geminiApiKey");
            if (!apiKey) {
                geminiError.textContent = "Error: No se encontr√≥ la clave de API. Recarga la p√°gina e introd√∫cela de nuevo.";
                geminiError.classList.remove("hidden");
                return;
            }

            const summary = studentSummary.value;
            if (!originalPdfText || !summary) {
                geminiError.textContent = "Aseg√∫rate de haber cargado un PDF y escrito un resumen.";
                geminiError.classList.remove("hidden");
                return;
            }

            // Mostrar estado de carga
            setLoadingState(true);

            const prompt = `
                Eres un profesor experto evaluando la capacidad de s√≠ntesis y razonamiento de un estudiante.
                El estudiante ha le√≠do el siguiente texto original:
                --- TEXTO ORIGINAL ---
                ${originalPdfText}
                --- FIN DEL TEXTO ORIGINAL ---

                Y ha escrito el siguiente resumen:
                --- RESUMEN DEL ESTUDIANTE ---
                ${summary}
                --- FIN DEL RESUMEN DEL ESTUDIANTE ---

                Por favor, proporciona una evaluaci√≥n constructiva en espa√±ol. Tu evaluaci√≥n debe:
                1.  Analizar si el resumen captura las ideas principales del texto original.
                2.  Se√±alar cualquier omisi√≥n importante o malinterpretaci√≥n.
                3.  Evaluar la claridad y coherencia del resumen.
                4.  Ofrecer sugerencias espec√≠ficas para mejorar.

                Formatea tu respuesta en HTML simple (p√°rrafos <p>, listas <ul><li> y negritas <b>). No uses markdown.
                Comienza con un encabezado <h3>Evaluaci√≥n del Resumen</h3>.
            `;
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.5,
                            topK: 1,
                            topP: 1,
                        }
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    let errorMsg = `Error ${response.status}: ${errorBody.error?.message || 'Error desconocido de la API.'}`;
                    if(response.status === 400) errorMsg = "Error: La clave de API parece ser inv√°lida o estar mal formada.";
                    if(response.status === 403) errorMsg = "Error: La clave de API no tiene permiso para acceder al servicio.";
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                const feedbackText = result.candidates[0].content.parts[0].text;

                iaFeedback.innerHTML = feedbackText;
                iaFeedbackPlaceholder.classList.add("hidden");
                geminiError.classList.add("hidden");

                // Guardar en Firestore
                await saveSummaryToFirestore(summary, feedbackText);

            } catch (error) {
                console.error("Error llamando a la API de Gemini:", error);
                geminiError.textContent = `Error: ${error.message}`;
                geminiError.classList.remove("hidden");
                iaFeedback.innerHTML = "";
                iaFeedbackPlaceholder.classList.remove("hidden");
            } finally {
                // Ocultar estado de carga
                setLoadingState(false);
            }
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                geminiEvaluateBtn.disabled = true;
                geminiBtnText.classList.add("hidden");
                geminiLoader.classList.remove("hidden");
            } else {
                geminiEvaluateBtn.disabled = false;
                geminiBtnText.classList.remove("hidden");
                geminiLoader.classList.add("hidden");
            }
        }

        async function saveSummaryToFirestore(summary, feedback) {
            if (!db || !userId) {
                console.warn("Firestore no est√° listo, no se pudo guardar.");
                return;
            }

            try {
                const summaryTitle = document.getElementById("summary-title-input").value.trim() || "Resumen sin t√≠tulo";
                
                // Usamos una colecci√≥n p√∫blica gen√©rica para esta app de "modo clase"
                // Aseg√∫rate de que tus reglas de seguridad lo permitan
                const docRef = await addDoc(collection(db, "resumenes_publicos"), {
                    userId: userId, // ID an√≥nimo
                    title: summaryTitle,
                    summary: summary,
                    feedback: feedback,
                    originalPdfName: pdfUpload.files[0]?.name || "N/A",
                    createdAt: serverTimestamp()
                });
                console.log("Resumen guardado en Firestore con ID: ", docRef.id);
            } catch (error) {
                console.error("Error al guardar en Firestore: ", error);
                // No molestar al usuario con este error, solo registrarlo
            }
        }

        // *** 8. FUNCIONES ADICIONALES (Contador de palabras, Descarga) ***
        const wordCount = document.getElementById("word-count");
        const downloadBtn = document.getElementById("download-btn");

        studentSummary.addEventListener("input", () => {
            const text = studentSummary.value.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCount.textContent = words;
            checkEnableButtons();
        });

        function checkEnableButtons() {
            const hasText = studentSummary.value.trim().length > 0;
            const hasPdf = originalPdfText.length > 0;

            geminiEvaluateBtn.disabled = !hasText || !hasPdf;
            downloadBtn.disabled = !hasText;
        }

        downloadBtn.addEventListener("click", () => {
            const title = document.getElementById("summary-title-input").value.trim() || "Mi_Resumen";
            const summaryText = studentSummary.value;
            const feedbackHtml = iaFeedback.innerHTML;
            
            // Convertir feedback HTML a texto plano simple para el TXT
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = feedbackHtml;
            const feedbackText = tempDiv.textContent || tempDiv.innerText || "";

            const content = `
T√çTULO: ${title}
---------------------------------
TU RESUMEN:
---------------------------------
${summaryText}

---------------------------------
EVALUACI√ìN DE LA IA:
---------------------------------
${feedbackText}
            `;
            
            const blob = new Blob([content.trim()], { type: "text/plain;charset=utf-8" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${title.replace(/ /g, "_")}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        
        // *** 9. INICIO DE LA APLICACI√ìN ***
        // Llama a initApp() al cargar la p√°gina para comprobar si la clave ya existe
        initApp();

    </script>
</body>
</html>
